document.addEventListener("DOMContentLoaded",()=>{initializeApp();});let currentUser=null;let isLoading=false;function initializeApp(){setupEventListeners();checkConnection();}function setupEventListeners(){document.querySelectorAll(".nav-link").forEach(link=>{link.addEventListener("click",(e)=>{e.preventDefault();showSection(link.dataset.section);});});document.querySelector(".search-toggle")?.addEventListener("click",toggleSearch);document.querySelector(".close-search")?.addEventListener("click",toggleSearch);document.getElementById("searchAction")?.addEventListener("click",performSearch);document.getElementById("globalSearch")?.addEventListener("keypress",(e)=>{if(e.key==="Enter")performSearch();});document.getElementById("exploreContent")?.addEventListener("click",()=>{showSection("movies");});document.querySelector(".modal-close")?.addEventListener("click",()=>{document.getElementById("mediaModal").style.display="none";});document.getElementById("logoutBtn")?.addEventListener("click",()=>{authSystem.logout();});}function showSection(sectionId){document.querySelectorAll(".nav-link").forEach(link=>link.classList.remove("active"));document.querySelector(`.nav-link[data-section="${sectionId}"]`)?.classList.add("active");document.querySelectorAll(".content-section").forEach(section=>section.classList.remove("active"));const target=document.getElementById(`${sectionId}Section`);if(target){target.classList.add("active");switch(sectionId){case"movies":loadMovies();break;case"series":loadSeries();break;case"anime":loadAnime();break;case"library":librarySystem.showCategory("watchlist");break;}}}function toggleSearch(){const overlay=document.querySelector(".search-overlay");overlay.style.display=overlay.style.display==="block"?"none":"block";if(overlay.style.display==="block")document.getElementById("globalSearch").focus();}async function performSearch(){const query=document.getElementById("globalSearch").value;const category=document.getElementById("searchCategory").value;if(!query.trim())return;showLoading();try{if(category==="anime"){await searchAnime(query);}else{await searchTMDB(query,category);}}catch(error){console.error("Search error:",error);showNotification("Error en bÃºsqueda","error");}finally{hideLoading();}}async function searchTMDB(query,type){const endpoint=type==="multi"?"/search/multi":`/search/${type}`;const url=`${TMDB_CONFIG.base_url}${endpoint}?api_key=${TMDB_CONFIG.api_key}&query=${encodeURIComponent(query)}&language=es-ES`;try{const data=await fetchWithCache(url,'tmdb-search');displaySearchResults(data.results||[],"tmdb");}catch(error){console.error("Search error:",error);showNotification("Error en bÃºsqueda. Intenta nuevamente.","error");}}async function searchAnime(query){const url=`${JIKAN_CONFIG.base}${JIKAN_CONFIG.endpoints.animeSearch}?q=${encodeURIComponent(query)}&limit=20`;const response=await fetch(url);const data=await response.json();displaySearchResults(data.data||[],"anime");}function displaySearchResults(items,type){const container=document.getElementById("searchResults");if(!container)return;container.innerHTML=items.map(item=>createContentCard(item,type)).join("");container.querySelectorAll(".content-card").forEach(card=>{card.addEventListener("click",()=>showDetails(card.dataset.id,card.dataset.type));});}window.loadContent=function(){if(!contentMode.shouldShow("tmdb")&&!contentMode.shouldShow("anime")){contentMode.showSelector();return;}showLoading();try{const promises=[];if(contentMode.shouldShow("tmdb")){promises.push(loadTrending(),loadMovies(),loadSeries());}if(contentMode.shouldShow("anime")){promises.push(loadAnime());}Promise.all(promises).then(()=>hideLoading());}catch(error){console.error("Load error:",error);hideLoading();}}async function loadTrending(){const url=`${TMDB_CONFIG.base_url}/trending/all/day?api_key=${TMDB_CONFIG.api_key}&language=es-ES`;try{const response=await fetch(url);const data=await response.json();displayTrending(data.results||[]);}catch(error){console.error("Trending error:",error);}}function displayTrending(items){const container=document.getElementById("trendingScroller");if(!container)return;container.innerHTML=items.slice(0,10).map(item=>createTrendingCard(item)).join("");container.querySelectorAll(".content-card").forEach(card=>{card.addEventListener("click",()=>showDetails(card.dataset.id,card.dataset.type));});}function createTrendingCard(item){const title=item.title||item.name;const year=(item.release_date||item.first_air_date)?.split("-")[0]||"";const image=item.poster_path?`${TMDB_CONFIG.image_base}/w300${item.poster_path}`:"https://via.placeholder.com/300x450";return`<div class="content-card" data-id="${item.id}" data-type="${item.media_type||(item.title?"movie":"tv")}"><img src="${image}" alt="${title}" class="card-image"><div class="card-info"><h3 class="card-title">${title}</h3><div class="card-meta"><span>${year}</span></div></div></div>`;}async function loadMovies(){const url=`${TMDB_CONFIG.base_url}/discover/movie?api_key=${TMDB_CONFIG.api_key}&language=es-ES&sort_by=popularity.desc&page=1`;try{const response=await fetch(url);const data=await response.json();displayContent(data.results||[],"moviesGrid","tmdb");}catch(error){console.error("Movies error:",error);}}async function loadSeries(){const url=`${TMDB_CONFIG.base_url}/discover/tv?api_key=${TMDB_CONFIG.api_key}&language=es-ES&sort_by=popularity.desc&page=1`;try{const response=await fetch(url);const data=await response.json();displayContent(data.results||[],"seriesGrid","tmdb");}catch(error){console.error("Series error:",error);}}async function loadAnime(){const url=`${JIKAN_CONFIG.base}${JIKAN_CONFIG.endpoints.topAnime}?limit=20`;try{const response=await fetch(url);const data=await response.json();displayContent(data.data||[],"animeGrid","anime");}catch(error){console.error("Anime error:",error);}}function displayContent(items,containerId,type){const container=document.getElementById(containerId);if(!container)return;container.innerHTML=items.map(item=>createContentCard(item,type)).join("");container.querySelectorAll(".content-card").forEach(card=>{card.addEventListener("click",()=>showDetails(card.dataset.id,card.dataset.type));});}function createContentCard(item,type="tmdb"){if(type==="tmdb"){const title=item.title||item.name;const year=(item.release_date||item.first_air_date)?.split("-")[0]||"";const rating=item.vote_average?.toFixed(1)||"N/A";const image=item.poster_path?`${TMDB_CONFIG.image_base}/w185${item.poster_path}`:"https://via.placeholder.com/185x278?text=Sin+imagen";return`<div class="content-card" data-id="${item.id}" data-type="${item.media_type||(item.title?"movie":"tv")}"><div class="card-image-container"><img src="${image}" alt="${title}" class="card-image" loading="lazy"><div class="card-rating">â­${rating}</div></div><div class="card-info"><h3 class="card-title">${title}</h3><div class="card-meta"><span>${year}</span><span class="card-type">${item.media_type==="movie"?"ğŸ¬":"ğŸ“º"}</span></div></div></div>`;}else{const title=item.title||item.title_english||item.title_japanese;const year=item.year||"";const rating=item.score?.toFixed(1)||"N/A";const image=item.images?.jpg?.image_url||"https://via.placeholder.com/185x278?text=Anime";return`<div class="content-card" data-id="${item.mal_id}" data-type="anime"><div class="card-image-container"><img src="${image}" alt="${title}" class="card-image" loading="lazy"><div class="card-rating">â­${rating}</div></div><div class="card-info"><h3 class="card-title">${title}</h3><div class="card-meta"><span>${year}</span><span class="card-type">ğŸ‡¯ğŸ‡µ</span></div></div></div>`;}}window.showDetails=async function(id,type){showLoading();try{let details;if(type==="anime"){details=await getAnimeDetails(id);}else{details=await getTMDBDetails(id,type);}displayDetails(details,type);document.getElementById("mediaModal").style.display="flex";}catch(error){console.error("Details error:",error);showNotification("Error cargando detalles","error");}finally{hideLoading();}}async function getTMDBDetails(id,type){const endpoint=type==="movie"?TMDB_CONFIG.endpoints.movie.details:TMDB_CONFIG.endpoints.tv.details;const url=`${TMDB_CONFIG.base_url}${endpoint.replace("{movie_id}",id).replace("{series_id}",id)}?api_key=${TMDB_CONFIG.api_key}&language=es-ES`;const response=await fetch(url);return await response.json();}async function getAnimeDetails(id){const url=`${JIKAN_CONFIG.base}${JIKAN_CONFIG.endpoints.animeDetails.replace("{id}",id)}`;const response=await fetch(url);const data=await response.json();return data.data;}function displayDetails(details,type){const container=document.getElementById("modalBody");if(type==="anime"){container.innerHTML=createAnimeDetails(details);}else{container.innerHTML=createTMDBDetails(details,type);}}function sanitizeHTML(text){if(!text)return"";const div=document.createElement('div');div.textContent=text;return div.innerHTML;}function createTMDBDetails(details,type){const title=details.title||details.name;const year=(details.release_date||details.first_air_date)?.split("-")[0]||"";const rating=details.vote_average?.toFixed(1)||"N/A";const image=details.poster_path?`${TMDB_CONFIG.image_base}/w500${details.poster_path}`:"https://via.placeholder.com/500x750";const genres=(details.genres||[]).map(g=>g.name).join(", ");const overview=sanitizeHTML(details.overview||"Sin descripciÃ³n.");return`<div class="modal-details"><div class="detail-image"><img src="${image}" alt="${title}"></div><div class="detail-content"><h2>${title}(${year})</h2><div class="detail-meta"><span>â­${rating}/10</span><span>${details.runtime||details.episode_run_time?.[0]||"N/A"}min</span></div><div class="detail-genres">${genres}</div><p class="detail-overview">${overview}</p><div class="detail-actions"><button class="action-btn watch-btn"><i class="fas fa-play"></i>Ver</button><button class="action-btn library-btn" onclick="librarySystem.addItem(${JSON.stringify({...details,type:type==="movie"?"movie":"tv",id:details.id})},'watchlist')"><i class="fas fa-plus"></i>Mi Lista</button></div></div></div>`;}function createAnimeDetails(details){const title=details.title||details.title_english||details.title_japanese;const year=details.year||"";const rating=details.score?.toFixed(1)||"N/A";const image=details.images?.jpg?.large_image_url||"https://via.placeholder.com/500x750";const genres=(details.genres||[]).map(g=>g.name).join(", ");const synopsis=sanitizeHTML(details.synopsis||"Sin sinopsis.");return`<div class="modal-details"><div class="detail-image"><img src="${image}" alt="${title}"></div><div class="detail-content"><h2>${title}(${year})</h2><div class="detail-meta"><span>â­${rating}/10</span><span>${details.episodes||"N/A"}episodios</span></div><div class="detail-genres">${genres}</div><p class="detail-overview">${synopsis}</p><div class="detail-actions"><button class="action-btn watch-btn"><i class="fas fa-play"></i>Ver</button><button class="action-btn library-btn" onclick="librarySystem.addItem(${JSON.stringify({...details,type:"anime",id:details.mal_id})},'watchlist')"><i class="fas fa-plus"></i>Mi Lista</button></div></div></div>`;}const contentCache=new Map();const CACHE_DURATION=5*60*1000;async function fetchWithCache(url,type){const now=Date.now();const cached=contentCache.get(url);if(cached&&(now-cached.timestamp<CACHE_DURATION)){return cached.data;}try{const response=await fetch(url);if(!response.ok)throw new Error(`HTTP ${response.status}`);const data=await response.json();contentCache.set(url,{data,timestamp:now});return data;}catch(error){console.error("Fetch error:",error);if(cached)return cached.data;throw error;}}function checkConnection(){if(!navigator.onLine){showNotification("Sin conexiÃ³n. Modo offline activado.","warning");document.body.classList.add('offline');}else{document.body.classList.remove('offline');}}window.addEventListener('online',checkConnection);window.addEventListener('offline',checkConnection);function showLoading(){isLoading=true;document.body.classList.add("loading");}function hideLoading(){isLoading=false;document.body.classList.remove("loading");}function showNotification(message,type="info"){const notification=document.getElementById("globalNotification");notification.textContent=message;notification.style.background=type==="success"?"var(--success)":type==="error"?"var(--accent)":type==="warning"?"var(--warning)":"var(--primary)";notification.style.display="block";setTimeout(()=>{notification.style.display="none";},3000);}